name: Build and Deploy vite front end

on:
    push:
        branches: [ main ]
    workflow_dispatch: 

permissions: 
    contents: write

concurrency:
  group: build-${{ github.ref }}
  cancel-in-progress: true


jobs:
    build:
        name: Compiling files
        runs-on: ubuntu-latest

        steps:
        # Step 1: Checkout the code
        - name: Checkout repository
          uses: actions/checkout@v3

        - name: Setup Node.JS
          uses: actions/setup-node@v3

        
        
        - name: Fetch and merge production branch
          run: |
                git config --global user.name "GitHub Actions"
                git config --global user.email "actions@github.com"
                # Fetch production branch
                git fetch origin production
                # Rebase main onto production (to ensure we have the latest main changes on production)
                git checkout production
                git pull --rebase origin main  # Ensure the latest main changes are on production

                # Merge main into production (automatically resolving some conflicts)
                git merge origin/main -m "Merging main into production"
                # In case of merge conflicts, use git merge --abort or handle conflicts automatically
                if [ $? -ne 0 ]; then
                git merge --abort  # Abort the merge if there are conflicts
                echo "Merge failed, conflicts need to be resolved."
                exit 1  # Fail the CI job if conflicts need to be handled manually
                fi

        - name: Install dependencies and build
          working-directory: pages/FrontEnd
          run: |
            npm install
            npm run build

        - name: Remove source code
          run: |
            rm -rf pages/FrontEnd
        
        

        - name: Deploy
          if: success()
          run: |
            COMMIT_ID=${GITHUB_SHA}
            git add .
            git rm -r pages/FrontEnd
            git add pages/build/* -f
            git commit -m "Deploy Vite app to production branch (Triggered by commit ${COMMIT_ID})"
            git push origin HEAD:production
            
              
        
